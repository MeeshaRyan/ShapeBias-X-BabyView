---
title: "BVTranscripts-Vs-CDIs"
output: html_document
date: "2025-10-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

i want to match the lemmas that appear in bv transc. to lemmas in bv cdis and then see, within age group, how many times each word appears in both datasets

so i need to:
- apply age groups to the bv cdi df
- group by age group for the graph
- within each age group i need to know how many of the SAME unique lemmas appeared in both sources


```{r}
child_spoken <- bv_clean_age_calculated %>% 
  select(-orig_token, -age_started_recording, -token_start_time, -token_end_time) %>% 
  mutate(
    age_group = case_when(
      age >= 9 & age <= 12.9999 ~ "9-12",
      age >= 13 & age <= 15.9999 ~ "13-15", 
      age >= 16 & age <= 18.9999 ~ "16-18",
      age >= 19 & age <= 21.9999 ~ "19-21",
      age >= 22 & age <= 24.9999 ~ "22-24",
      age >= 25 & age <= 27.9999 ~ "25-27",
      age >= 28 & age <= 30 ~ "28-30",
      TRUE ~  NA_character_
      ), 
  lemma = tolower(lemma),
  source = "child-spoken",
    ) %>% 
  filter(!is.na(age_group))

bv_CDI <- combined_clean_l %>% 
  select(-sex, -birth_order, -file_tag) %>%
  mutate(age = as.numeric(age),
    age_group = case_when(
      age >= 8.9 & age <= 12.9999 ~ "9-12",
      age >= 13 & age <= 15.9999 ~ "13-15", 
      age >= 16 & age <= 18.9999 ~ "16-18",
      age >= 19 & age <= 21.9999 ~ "19-21",
      age >= 22 & age <= 24.9999 ~ "22-24",
      age >= 25 & age <= 27.9999 ~ "25-27",
      age >= 28 & age <= 30 ~ "28-30",
      TRUE ~  NA_character_
      ), 
    source = "bv_CDI",
    )
# names(child_spoken)
# names(bv_CDI)



combined_spoken_heard <- full_join(
  child_spoken,
  bv_CDI,
  by = "age_group", 
  suffix = c(".sp", ".cdi")
  )

## join error - vector limit reached
# n_sp <- child_spoken %>% count(age_group, name = "n_sp")
# n_cdi <- bv_CDI %>% count(age_group, name = "n_cdi")
# 
# n_sp %>%
#   inner_join(n_cdi, by = "age_group") %>%
#   mutate(prod = n_sp * n_cdi) %>%
#   summarise(total_rows_if_joined = sum(prod, na.rm = TRUE))



```


Attempting this again: using bv cdis df, filter for NA, run hunspell to get english words only (no special characters)

```{r}
library(tidyverse)
library(stringr)
library(hunspell)

bv_cdi_combined <- read.csv("/Users/meesha/Desktop/ShapeBias-X-BabyView/BV-Eng-CDIs/bv_cdis_combined.csv")

bv_cdi_combined2 <- bv_cdi_combined %>% 
 filter(!is.na(value))

test_clean <- bv_cdi_combined2 %>% 
  mutate(variable = str_replace(bv_cdi_combined2$variable, "\\..*$", "")) %>%
  filter(str_detect(variable, "^[A-Za-z_]+$"))

test_clean2 <- test_clean$variable[hunspell_check(test_clean$variable)]

test_clean2 <- as.data.frame(test_clean2)

test_filtered <- test_clean %>% 
  filter(variable %in% test_clean2$test_clean2)
view(test_filtered)


```

POS model for nouns, re-merge for the final df
```{r}
# Load udpipe model
library(udpipe)
model <- udpipe_download_model("english")
udmodel_english <- udpipe_load_model(model$file_model)

# Annotate with POS, keeping row_id
test_bv_cdis_pos <- udpipe_annotate(
  udmodel_english,
  x = test_filtered$variable,
  doc_id = test_filtered$administration_id
)
test_bv_cdis_pos_df <- as.data.frame(test_bv_cdis_pos)

test2_bv_cdis_pos_df <- test_bv_cdis_pos_df %>% 
  filter(upos == "NOUN")

bv_cdi_nouns2 <- test_filtered %>% 
  filter(variable %in% test2_bv_cdis_pos_df$lemma) %>% 
  filter(value == "understands")

write.csv(bv_cdi_nouns2, "bv_cdi_nouns_und.csv",row.names = FALSE)
#write.csv(bv_cdi_nouns, "bv_cdi_nouns.csv", row.names = FALSE)

view(test_filtered)

```

```{r}
#make a df with the frequencies of adult utterances for each lemma by age of the child?

#early_utt_per_child <- bv_cdi_nouns %>% 
  #group_by(subject_id, age)
  
library(tidyverse)
library(dplyr)

bv.cdi <- read.csv("/Users/meesha/Desktop/ShapeBias-X-BabyView/bv_cdi_nouns.csv")
child.heard <- read.csv("/Users/meesha/Desktop/ShapeBias-X-BabyView/bv_adult_nouns_child_age.csv")
bv.cdi.und <- read.csv("/Users/meesha/Desktop/ShapeBias-X-BabyView/bv_cdi_nouns_und.csv")
```

Samah: lets compare this (the 42 words younger kids produces from the bv-cdi) to the number of words from the genral cdi for the same age <= 16 mo
same for understands (number of kids/families)

```{r }
younger_prod <- bv.cdi %>% 
  filter(bv.cdi$age <= 16)

younger_heard <- child.heard %>% 
  filter(child.heard$age <= 16)

overlap_und <- intersect(bv.cdi.und$variable, younger_heard$lemma)
#overlap_prod <- intersect(bv.cdi$variable, child.heard$lemma)
overlap_young_prod <- intersect(younger_prod$variable, younger_heard$lemma)
ovrlap_young_prod_und <- intersect(younger_prod$variable, bv.cdi.und$variable )

length(overlap_young_prod)
length(overlap_und)
length(ovrlap_young_prod_und)

```

```{r }
older_heard <- child.heard %>% 
  filter(child.heard$age > 16)
max(older_heard$age)

older_prod <- bv.cdi %>% 
  filter(bv.cdi$age > 16)

overlap_old_prod <- intersect(older_prod$variable, older_heard$lemma)

kchi_nouns <- read.csv("/Users/meesha/Desktop/ShapeBias-X-BabyView/bv_main_age.csv")

vals <- kchi_nouns %>% select(lemma) %>% distinct()

# Extract unique words from the 'lemma' column
vals_words <- unique(kchi_nouns$lemma)

# --- Step 1: Filter for valid English words using hunspell ---
library(hunspell)

# hunspell_check returns a boolean vector indicating correctness
kchi_nouns_eng_words <- vals_words[hunspell_check(vals_words)]
vals1 <- as.data.frame(kchi_nouns_eng_words)
colnames(vals1) <- "lemma"
# remove all rows with only one character
vals1 <- vals1 %>% filter(nchar(lemma) > 2)
# remove all rows with numbers
vals1 <- vals1 %>% filter(!grepl("\\d", lemma))
# remove all rows with special characters (keep only letters and spaces)
vals1 <- vals1 %>% filter(grepl("^[a-zA-Z]+$", lemma))

kchi_nouns2 <- kchi_nouns %>% 
  filter(lemma %in% vals1$lemma)


younger_kchi_prod <- kchi_nouns2 %>% 
  filter(age <= 16)
  
older_kchi_prod <- kchi_nouns2 %>% 
  filter(age >= 17 & age <= 28.966 )


summary_Df <- older_kchi_prod %>% group_by(lemma) %>% summarize( count = n()) %>% filter(count > 1)

```


```{r}
length(older_heard$lemma)
length(older_prod$variable)
length(overlap_old_prod)
length(younger_heard$lemma)
length(unique(older_kchi_prod$lemma))

length(unique(kchi_nouns2$lemma))
```


```{r }
summary_df2 <- tibble(
set = c("BV-CDI", "Overlap", "BV-Heard"),
count = c(nrow(vals1), nrow(overlap), nrow(vals2))
)
ggplot(summary_df, aes(x = set, y = count, fill = set)) +
geom_col() +
labs(title = "Overlap of values between CDI and BV", x = NULL, y = "Number of unique values")


```

responding to Samah's comment above: we tried these things below

```{r}
general_cdi <- read.csv("/Users/meesha/Desktop/ShapeBias-X-BabyView/aoa_predictor_data.csv")

general_cdi_younger_prod <- general_cdi %>% 
  filter(language == "English (American)") %>% 
  filter(measure == "produces") %>% 
   filter(aoa < 17)


general_cdi_older_prod <- general_cdi %>% 
  filter(language == "English (American)") %>% 
  filter(measure == "produces") %>% 
   filter(  aoa >= 17 & aoa <= 28.966 ) 

```

